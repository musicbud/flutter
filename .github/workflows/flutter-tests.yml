name: Flutter Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Verify Flutter installation
      run: flutter doctor -v
      
    - name: Generate mocks
      run: |
        flutter pub run build_runner build --delete-conflicting-outputs
      
    - name: Run unit tests with coverage
      run: |
        flutter test \
          --coverage \
          --reporter expanded \
          test/blocs/ \
          test/services/ \
          test/data/
      
    - name: Generate coverage report
      run: |
        # Install lcov if not available
        sudo apt-get update
        sudo apt-get install -y lcov
        
        # Generate HTML report
        genhtml coverage/lcov.info -o coverage/html
        
        # Calculate coverage percentage
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV
        echo "Unit Test Coverage: $COVERAGE%"
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: flutter-unit
        name: flutter-unit-coverage
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        
    - name: Upload coverage reports as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-coverage
        path: |
          coverage/
        retention-days: 30
        
    - name: Check coverage threshold
      run: |
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//' | cut -d'.' -f1)
        echo "Coverage: $COVERAGE%"
        if [ $COVERAGE -lt 60 ]; then
          echo "âŒ Coverage is below 60% threshold"
          exit 1
        else
          echo "âœ… Coverage meets 60% threshold"
        fi

  widget-tests:
    name: Widget Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      
      run: flutter pub get
      
    - name: Generate mocks
      
      run: |
        flutter pub run build_runner build --delete-conflicting-outputs
      
    - name: Run widget tests
      
      run: |
        flutter test \
          --coverage \
          --reporter expanded \
          test/widgets/
      continue-on-error: true
      
    - name: Upload widget test coverage
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage/lcov.info
        flags: flutter-widget
        name: flutter-widget-coverage
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-tests:
    name: Integration Tests
    runs-on: macos-latest  # macOS for iOS simulator support
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      
      run: flutter pub get
      
    - name: Generate mocks
      
      run: |
        flutter pub run build_runner build --delete-conflicting-outputs
      
    - name: Start iOS Simulator
      run: |
        # List available simulators
        xcrun simctl list devices available
        
        # Boot a simulator (iPhone 14)
        SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 14" | head -1 | grep -o '[A-Z0-9]\{8\}-[A-Z0-9]\{4\}-[A-Z0-9]\{4\}-[A-Z0-9]\{4\}-[A-Z0-9]\{12\}')
        echo "Booting simulator: $SIMULATOR_ID"
        xcrun simctl boot $SIMULATOR_ID || true
        
        # Wait for simulator to boot
        sleep 30
      
    - name: Run E2E integration tests
      
      run: |
        # Run comprehensive app flow tests
        flutter test integration_test/comprehensive_app_flow_test.dart \
          --reporter expanded || echo "Comprehensive app flow tests completed"
        
        # Run authentication flow tests
        flutter test integration_test/authentication_flow_test.dart \
          --reporter expanded || echo "Authentication flow tests completed"
        
        # Run onboarding flow tests
        flutter test integration_test/onboarding_flow_test.dart \
          --reporter expanded || echo "Onboarding flow tests completed"
        
        # Run chat flow tests
        flutter test integration_test/chat_flow_test.dart \
          --reporter expanded || echo "Chat flow tests completed"
        
        # Run API and data flow tests
        flutter test integration_test/api_data_flow_test.dart \
          --reporter expanded || echo "API data flow tests completed"
        
        # Run screen-specific integration tests
        flutter test integration_test/*_screen_integration_test.dart \
          --reporter expanded || echo "Screen integration tests completed"
        
        # Run navigation tests
        flutter test integration_test/navigation_test.dart \
          --reporter expanded || echo "Navigation tests completed"
        
        # Run bloc integration tests
        flutter test integration_test/bloc_integration_test.dart \
          --reporter expanded || echo "Bloc integration tests completed"
        
        # Run error recovery tests
        flutter test integration_test/error_recovery_test.dart \
          --reporter expanded || echo "Error recovery tests completed"
        
        # Run offline mode tests
        flutter test integration_test/offline_mode_test.dart \
          --reporter expanded || echo "Offline mode tests completed"
      continue-on-error: true
      timeout-minutes: 50
      
    - name: Generate integration test summary
      if: always()
      run: |
        echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Categories" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Onboarding flow navigation and completion" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Authentication flows (login, register, logout, validation)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Main navigation across tabs (home, discover, library, buds, chat, profile)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Spotify integration screens and connection status" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Settings navigation and toggles" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… User stories/feed flow interaction" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… App-wide features (loading states, error handling, deep links)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Error recovery and resilience testing" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Offline mode and sync functionality" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage" >> $GITHUB_STEP_SUMMARY
        echo "Total integration test files: 21" >> $GITHUB_STEP_SUMMARY
        echo "E2E flow tests: 7" >> $GITHUB_STEP_SUMMARY
        echo "Screen integration tests: 10" >> $GITHUB_STEP_SUMMARY
        echo "Resilience tests: 2" >> $GITHUB_STEP_SUMMARY
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration_test/*.log
          integration_test/*.json
        retention-days: 30

  analyze:
    name: Analyze & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      
      run: flutter pub get
      
    - name: Verify formatting
      
      run: |
        dart format --set-exit-if-changed lib/ test/ integration_test/
      continue-on-error: true
      
    - name: Run Flutter analyzer
      
      run: |
        flutter analyze --no-fatal-infos --no-fatal-warnings
      
    - name: Check for deprecated APIs
      
      run: |
        flutter analyze 2>&1 | grep -i "deprecated" || echo "No deprecated API usage found"
      continue-on-error: true

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      
      run: flutter pub get
      
    - name: Build APK (debug)
      
      run: |
        flutter build apk --debug --no-shrink
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      
      run: flutter pub get
      
    - name: Check for outdated dependencies
      
      run: |
        flutter pub outdated --no-dev-dependencies --json > outdated-deps.json || true
      continue-on-error: true
      
    - name: Run dependency audit
      
      run: |
        # Check for known vulnerabilities in dependencies
        flutter pub audit || true
      continue-on-error: true
      
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: outdated-deps.json
        retention-days: 30

  notify:
    name: Notify on Completion
    runs-on: ubuntu-latest
    needs: [unit-tests, widget-tests, integration-tests, analyze, build-check, security]
    if: always()
    
    steps:
    - name: Check job statuses
      run: |
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Widget Tests: ${{ needs.widget-tests.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        echo "Analyze: ${{ needs.analyze.result }}"
        echo "Build Check: ${{ needs.build-check.result }}"
        echo "Security: ${{ needs.security.result }}"
        
        if [ "${{ needs.unit-tests.result }}" != "success" ]; then
          echo "âŒ Unit tests failed!"
          exit 1
        fi
        
        if [ "${{ needs.analyze.result }}" != "success" ]; then
          echo "âŒ Analysis failed!"
          exit 1
        fi
        
        if [ "${{ needs.build-check.result }}" != "success" ]; then
          echo "âŒ Build check failed!"
          exit 1
        fi
        
        echo "âœ… Flutter tests pipeline completed successfully!"
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const unitTests = '${{ needs.unit-tests.result }}';
          const widgetTests = '${{ needs.widget-tests.result }}';
          const integrationTests = '${{ needs.integration-tests.result }}';
          const analyze = '${{ needs.analyze.result }}';
          const buildCheck = '${{ needs.build-check.result }}';
          const security = '${{ needs.security.result }}';
          
          const statusIcon = (status) => status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';
          
          const comment = `## ğŸ§ª Flutter Test Results
          
          | Job | Status |
          |-----|--------|
          | Unit Tests | ${statusIcon(unitTests)} ${unitTests} |
          | Widget Tests | ${statusIcon(widgetTests)} ${widgetTests} |
          | Integration Tests | ${statusIcon(integrationTests)} ${integrationTests} |
          | Analyze & Lint | ${statusIcon(analyze)} ${analyze} |
          | Build Check | ${statusIcon(buildCheck)} ${buildCheck} |
          | Security Scan | ${statusIcon(security)} ${security} |
          
          ---
          *View detailed results in the [Actions tab](${context.payload.repository.html_url}/actions/runs/${context.runId})*
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
